Metadata-Version: 2.4
Name: caddy-tui
Version: 0.1.0
Summary: TUI + CLI tool to manage Caddy configs via SQLite
Author-email: Alex Hilton <alex@skystamper.com>
Requires-Python: >=3.12
Description-Content-Type: text/markdown
Requires-Dist: click>=8.1
Requires-Dist: SQLAlchemy>=2.0
Requires-Dist: rich>=13.7
Requires-Dist: packaging>=23.2
Requires-Dist: colorama>=0.4
Provides-Extra: test
Requires-Dist: pytest; extra == "test"
Requires-Dist: pytest-mock; extra == "test"

# caddy-tui

An interactive terminal UI plus CLI toolkit (built with Colorama + Rich) that keeps Caddy configuration in SQLite (`~/.caddy-tui/config.db`), lets you inspect/import data, and safely regenerates validated configs before reloading the Caddy service.

## Quick start

```bash
pip install -e .
caddy-tui init
sudo caddy-tui import --caddyfile /etc/caddy/Caddyfile
caddy-tui tui
```

The CLI prints JSON so it can slot straight into scripts, CI jobs, or other automation.

## Core commands

| Command | Purpose |
| --- | --- |
| `caddy-tui init` | Create the SQLite schema at `~/.caddy-tui/config.db`. |
| `caddy-tui import --caddyfile PATH` | Parse an existing Caddyfile and load it into the DB. Use `sudo` when PATH lives under `/etc/caddy`. |
| `caddy-tui list-sites` / `add-site` / `remove-site` | Manage site definitions directly from the CLI. |
| `caddy-tui apply` | Regenerate a Caddyfile from the DB, validate it, and reload Caddy via `systemctl reload caddy` (run with sudo). |
| `caddy-tui status [--caddyfile PATH] [--diff]` | Compare the DB-rendered config with the specified Caddyfile (defaults to the last imported path). Exits with code 1 when drift is detected. |
| `caddy-tui tui` | Launch the interactive scrolling menu for importing files and reviewing drift. |

### Status command

Use `caddy-tui status --diff` (typically with sudo) to verify the live `/etc/caddy/Caddyfile` still matches the SQLite data. The tool prints hashes, whether everything is in sync, and a truncated unified diff when requested. This is handy in CI or cron to catch manual edits.

### Importing system Caddyfiles

Most distro packages restrict `/etc/caddy/Caddyfile` to root. Keep the TUI unprivileged and run imports as needed via:

```bash
sudo /home/alexander_skystamper_com/projects/caddy-tui/.venv/bin/caddy-tui import --caddyfile /etc/caddy/Caddyfile
```

The database directory honours `SUDO_USER`, so the sudo-run import updates the same `~/.caddy-tui/config.db` that the TUI uses.

#### Privileged helper (optional)

If you prefer to grant finely scoped permissions instead of full `sudo caddy-tui`, install the accompanying helper entry point:

```
sudo visudo -f /etc/sudoers.d/caddy-tui
# Allow your user to run the helper without a password
alexander  ALL=(ALL) NOPASSWD: /usr/local/bin/caddy-tui-helper
```

`caddy-tui-helper` only supports three operations: mirroring the system Caddyfile into your cache, installing a generated file back into `/etc/caddy`, and reloading the Caddy service. When the TUI hits a permission error it prints the exact helper command (e.g. `sudo caddy-tui-helper mirror --source /etc/caddy/Caddyfile ...`) so you can re-run it immediately or let sudoers execute it without a prompt.

The helper runner resolves the executable to an absolute path before invoking sudo, so as long as `which caddy-tui-helper` works in your shell you do not need to export `CADDY_TUI_HELPER_BIN`. Just copy that `which` output into the sudoers entry (`alexander ALL=(ALL) NOPASSWD: /home/.../.venv/bin/caddy-tui-helper`) so sudo can locate the same binary.

## Interactive menu overview

`caddy-tui tui` prints a repeating block in this order:

1. Result of the previous selection (e.g. import success, drift diff panel).
2. A Rich table that captures database readiness, site count, last import path, and drift summary.
3. A context-aware menu. Options currently include:
    - `i` – Import the current Caddyfile path (auto-detects common locations).
    - `h` – Helper-assisted import. Uses the privileged helper interactively so sudo can prompt for a password before mirroring `/etc/caddy/Caddyfile`.
    - `d` – Show the unified diff between the DB-rendered config and `/etc/caddy/Caddyfile` (available once an import path exists). The diff is shown inside a Rich panel and can be copied directly from the terminal scrollback.
    - `q` – Quit the session.

Every action prints the exact helper command when elevated access is required, so you can copy/paste or add it to sudoers immediately.

## Example workflow

1. Initialise the DB: `caddy-tui init`.
2. Import the live config: `sudo caddy-tui import --caddyfile /etc/caddy/Caddyfile`.
3. Launch `caddy-tui tui`, edit sites, and review status messages.
4. Apply and reload: `sudo caddy-tui apply`.
5. Keep an eye on drift: `sudo caddy-tui status --diff` in CI or a nightly cron.

## How to run locally

```bash
python3 -m venv .venv
source .venv/bin/activate
pip install -e .[test]
pytest
caddy-tui tui
```

Run privileged steps (import/apply/status) with sudo, but keep the interactive menu under your normal user account.
